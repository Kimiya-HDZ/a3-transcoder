<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>A3 Transcoder</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 0; background:#f6f6f6; color:#222; }
    .wrap { max-width: 900px; margin: 30px auto; padding: 0 16px; }
    .card { background:#fff; border:1px solid #e6e6e6; border-radius:12px; padding:16px; margin-bottom:14px; box-shadow:0 6px 18px rgba(0,0,0,.06); }
    h1 { margin:0 0 14px; }
    label { display:block; margin:10px 0 6px; font-weight:600; }
    input[type=text], input[type=password], select, input[type=file] { width:100%; padding:10px; border:1px solid #ccc; border-radius:8px; }
    button { border:0; border-radius:10px; padding:12px 14px; background:#222; color:#fff; font-weight:700; cursor:pointer; }
    button[disabled] { opacity:.5; cursor:not-allowed; }
    .row { display:flex; gap:10px; }
    .row > * { flex:1; }
    .hidden { display:none; }
    .pill { display:inline-block; padding:4px 10px; border-radius:999px; background:#eee; }
    .logs { white-space:pre-wrap; background:#fafafa; border:1px dashed #ddd; border-radius:8px; padding:10px; font-size:13px; }
    .vid { margin-top:10px; }
    a { color:#222; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>A3 Transcoder</h1>

    <!-- Login -->
    <div class="card" id="loginCard">
      <div class="row">
        <div>
          <label>Username</label>
          <input id="user" type="text" placeholder="kimia / sara / admin">
        </div>
        <div>
          <label>Password</label>
          <input id="pass" type="password" placeholder="••••••••">
        </div>
      </div>
      <div class="row" style="margin-top:10px;">
        <button id="btnLogin">Login</button>
      </div>
      <div id="loginMsg" style="margin-top:10px;color:#b00;"></div>
    </div>

    <!-- App -->
    <div class="card hidden" id="appCard">
      <div style="display:flex; align-items:center; gap:10px; justify-content:space-between;">
        <div>
          <span id="who"></span>
          <span class="pill" id="statusPill">idle</span>
        </div>
        <button id="btnLogout">Logout</button>
      </div>

      <hr style="margin:14px 0; border:none; border-top:1px solid #eee;">

      <label>1) Pick a video file</label>
      <input type="file" id="file" accept="video/*">
      <div class="row" style="margin-top:10px;">
        <div>
          <label>Preset</label>
          <select id="preset">
            <option value="mp4-720p">mp4-720p (1280×720)</option>
            <option value="mp4-1080p">mp4-1080p (1920×1080)</option>
          </select>
        </div>
        <div style="align-self:end;">
          <button id="btnStart">Upload & Transcode</button>
        </div>
      </div>

      <div id="jobLine" class="hidden" style="margin-top:10px;">
        Job ID: <code id="jobId"></code>
      </div>

      <div id="result" class="vid"></div>

      <div class="logs" id="logs" style="margin-top:10px;">Ready.</div>
    </div>
  </div>

  <script>
    // --- helpers ---
    const $ = (id) => document.getElementById(id);
    const show = (el, on) => el.classList[on ? "remove" : "add"]("hidden");
    const setStatus = (t) => { $("statusPill").textContent = t; };

    let token = null;
    let pollTimer = null;

    function saveToken(t){ localStorage.setItem("jwt", t); }
    function loadToken(){ return localStorage.getItem("jwt"); }
    function clearToken(){ localStorage.removeItem("jwt"); }

    async function api(path, options = {}){
      const headers = options.headers || {};
      if (token) headers["Authorization"] = "Bearer " + token;
      return fetch(path, { ...options, headers });
    }

    async function resume(){
      const t = loadToken();
      if (!t) return false;
      token = t;
      const r = await api("/auth/me");
      if (!r.ok) { clearToken(); token = null; return false; }
      const me = await r.json();
      $("who").textContent = `${me.username} (${me.role})`;
      show($("loginCard"), false);
      show($("appCard"), true);
      setStatus("idle");
      return true;
    }

    $("btnLogin").onclick = async () => {
      $("loginMsg").textContent = "";
      const username = $("user").value.trim();
      const password = $("pass").value.trim();
      try {
        const r = await fetch("/auth/login", {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({ username, password })
        });
        const data = await r.json();
        if (!r.ok) throw new Error(data.detail || "Login failed");
        token = data.access_token;
        saveToken(token);
        await resume();
      } catch (e) {
        $("loginMsg").textContent = e.message;
      }
    };

    $("btnLogout").onclick = () => {
      clearToken(); token = null;
      if (pollTimer) clearInterval(pollTimer);
      pollTimer = null;
      $("logs").textContent = "Logged out.";
      show($("appCard"), false); show($("loginCard"), true);
    };

    // --- main flow ---
    $("btnStart").onclick = async () => {
      const f = $("file").files[0];
      if (!f) return alert("Pick a file first.");
      $("result").innerHTML = "";
      setStatus("preparing");
      $("logs").textContent = "Requesting pre-signed URL…";

      // 1) Ask API for pre-signed PUT URL
      const upRes = await api("/videos/upload-url", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ filename: f.name, contentType: f.type || "video/mp4" })
      });
      const up = await upRes.json();
      if (!upRes.ok) { $("logs").textContent = "Upload-URL error: " + (up.detail || upRes.status); setStatus("error"); return; }

      // 2) PUT the file to S3 directly
      $("logs").textContent = "Uploading to S3…";
      const putRes = await fetch(up.uploadUrl, { method: "PUT", headers: { "Content-Type": f.type || "video/mp4" }, body: f });
      if (!putRes.ok) { $("logs").textContent = "S3 upload failed ("+putRes.status+")"; setStatus("error"); return; }

      // 3) Create a job
      $("logs").textContent = "Creating job…";
      const preset = $("preset").value;
      const jobRes = await api("/transcode", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ inputKey: up.key, preset })
      });
      const job = await jobRes.json();
      if (!jobRes.ok) { $("logs").textContent = "Create job error: " + (job.detail || jobRes.status); setStatus("error"); return; }

      $("jobId").textContent = job.jobId;
      show($("jobLine"), true);
      setStatus("running");
      $("logs").textContent = "Job queued. Polling status every 2s…";

      // 4) Poll status
      if (pollTimer) clearInterval(pollTimer);
      pollTimer = setInterval(async () => {
        const r = await api(`/jobs/${job.jobId}`);
        const data = await r.json();
        if (!r.ok) { $("logs").textContent = "Status error."; return; }
        $("logs").textContent = JSON.stringify(data, null, 2);

        if (data.status === "DONE" || data.status === "FAILED") {
          clearInterval(pollTimer);
          setStatus(data.status.toLowerCase());
          if (data.status === "DONE" && data.downloadUrl) {
            $("result").innerHTML = `
              <div>Output ready:</div>
              <div class="vid">
                <video controls playsinline src="${data.downloadUrl}" style="max-width:100%; background:#000;"></video>
              </div>
              <div style="margin-top:6px;">
                <a href="${data.downloadUrl}" target="_blank" rel="noopener">Download MP4</a>
              </div>
            `;
          }
        }
      }, 2000);
    };

    // boot
    resume();
  </script>
</body>
</html>
